<div class="container mt-4">
    <h1 class="mb-4">Thống Kê Chi Tiêu</h1>

    {{!-- Bộ lọc thời gian --}}
    <div class="card mb-4">
        <div class="card-body">
            <form action="/statistics" method="GET" class="row g-3">
                <div class="col-md-5">
                    <label class="form-label">Từ ngày</label>
                    <input type="date" name="startDate" class="form-control" 
                           value="{{moment startDate 'YYYY-MM-DD'}}" required>
                </div>
                <div class="col-md-5">
                    <label class="form-label">Đến ngày</label>
                    <input type="date" name="endDate" class="form-control" 
                           value="{{moment endDate 'YYYY-MM-DD'}}" required>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-success w-100">Lọc</button>
                </div>
            </form>
        </div>
    </div>

    {{!-- Hiển thị khoảng thời gian đang xem --}}
    <div class="alert alert-info mb-4">
        Thống kê từ ngày {{moment startDate 'DD/MM/YYYY'}} đến {{moment endDate 'DD/MM/YYYY'}}
    </div>

    {{!-- Thống kê tổng quan --}}
    <div class="row mb-4">
        <div class="col-12 mb-4">
            <div class="card {{#if (lt balance 0)}}bg-danger{{else}}bg-success{{/if}} text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Tình trạng chi tiêu</h5>
                        <div class="d-flex align-items-center">
                            <h3 class="mb-0">
                                {{#if (lt balance 0)}}
                                    -{{formatCurrency (multiply balance -1)}} đ
                                {{else if (eq balance 0)}}
                                    Thu Chi Cân Bằng
                                {{else}}
                                    +{{formatCurrency balance}} đ
                                {{/if}}
                            </h3>
                        </div>
                    </div>
                    <small>
                        {{#if (lt balance 0)}}
                            Bạn nên cân nhắc giảm bớt chi tiêu không cần thiết
                        {{else if (eq balance 0)}}
                            Hãy cố gắng tăng thu nhập trong thời gian tới
                        {{else}}
                            Hãy tiếp tục duy trì thói quen chi tiêu tốt này
                        {{/if}}
                    </small>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">Thu Nhập </h5>
                    <h3 class="card-text">{{formatCurrency totalIncome}} đ</h3>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <h5 class="card-title">Chi Tiêu</h5>
                    <h3 class="card-text">{{formatCurrency totalExpense}} đ</h3>
                </div>
            </div>
        </div>
    </div>

    {{!-- Biểu đồ --}}
    <div class="row">
        {{!-- Biểu đồ tròn chi tiêu theo danh mục --}}
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Chi tiêu theo danh mục</h5>
                    <canvas id="pieChart"></canvas>
                </div>
            </div>
        </div>

        {{!-- Biểu đồ đường thu chi theo thời gian --}}
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Thu chi theo thời gian</h5>
                    <canvas id="lineChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

{{!-- Script vẽ biểu đồ --}}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Dữ liệu cho biểu đồ tròn
    const pieChartData = {{{pieChartData}}};
    new Chart(document.getElementById('pieChart'), {
        type: 'pie',
        data: {
            labels: pieChartData.labels,
            datasets: [{
                data: pieChartData.data,
                backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                    '#FF9F40', '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Dữ liệu cho biểu đồ đường
    const lineChartData = {{{lineChartData}}};
    new Chart(document.getElementById('lineChart'), {
        type: 'line',
        data: {
            labels: lineChartData.labels,
            datasets: [
                {
                    label: 'Thu nhập',
                    data: lineChartData.income,
                    borderColor: '#36A2EB',
                    fill: false
                },
                {
                    label: 'Chi tiêu',
                    data: lineChartData.expense,
                    borderColor: '#FF6384',
                    fill: false
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Xử lý ẩn/hiện số dư
    document.addEventListener('DOMContentLoaded', function() {
        const toggleBalance = document.querySelector('.toggle-balance');
        const balanceAmount = document.querySelector('.balance-amount');
        const balanceHidden = document.querySelector('.balance-hidden');
        
        // Lấy trạng thái từ localStorage (nếu có)
        let isBalanceVisible = localStorage.getItem('isBalanceVisible') === 'true';
        
        // Cập nhật hiển thị ban đầu dựa trên trạng thái đã lưu
        if (isBalanceVisible) {
            balanceAmount.style.display = 'block';
            balanceHidden.style.display = 'none';
            toggleBalance.innerHTML = '<i class="fas fa-eye"></i>';
        }

        toggleBalance.addEventListener('click', function() {
            isBalanceVisible = !isBalanceVisible;
            
            // Lưu trạng thái vào localStorage
            localStorage.setItem('isBalanceVisible', isBalanceVisible);
            
            if (isBalanceVisible) {
                balanceAmount.style.display = 'block';
                balanceHidden.style.display = 'none';
                toggleBalance.innerHTML = '<i class="fas fa-eye"></i>';
            } else {
                balanceAmount.style.display = 'none';
                balanceHidden.style.display = 'block';
                toggleBalance.innerHTML = '<i class="fas fa-eye-slash"></i>';
            }
        });
    });
</script>
